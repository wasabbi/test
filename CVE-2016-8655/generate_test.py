import os
import re

tid1 = 1124
tid2 = 1125

__start_routine1 = 0x40083d
__start_routine2 = 0x4008b1

sched1 = 1
sched2 = 2

cve_path = "./CVE-2017-10661"

line_index = 1

NewVersionInput = True

os.system("rm -rf ./testcase/test_*")
with open('kernel_race_pair_cve.txt', 'r') as race_pair_f:
    for line in race_pair_f.readlines():
        race_pair_list = []
        thread1_insts = []
        thread2_insts = []

        s = line.replace("L","")
        m = re.findall("(\[.+\])", s)
        race_pair_list = []
        exec("race_pair_list = " + m[0])

        race_pair_index = 1
        for race_pair in race_pair_list:
            data = ''
            with open('test_template.py', 'r') as f:
                for line in f.readlines():
                    if(line.find('target = "CVE_PATH"') == 0):
                        line = 'target = \"%s\"' % (cve_path,) + '\n'

                    if(line.find('thread1 = 0x0') == 0):
                        line = 'thread1 = %s' % (hex(__start_routine1),) + '\n'
                    if(line.find('thread2 = 0x0') == 0):
                        line = 'thread2 = %s' % (hex(__start_routine2),) + '\n'

                    if(line.find('hw_bp1 = [0x0, 0, 0x0]') == 0):
                        if(race_pair[0]["tid"] == tid1):
                            line = 'hw_bp1 = [%s, %s, %s]' % (race_pair[0]["pc"], str(sched1),hex(__start_routine1),) + '\n'
                        elif(race_pair[1]["tid"] == tid1):
                            line = 'hw_bp1 = [%s, %s, %s]' % (race_pair[1]["pc"], str(sched1),hex(__start_routine1),) + '\n'
                    if(line.find('hw_bp2 = [0x0, 0, 0x0]') == 0):
                        if(race_pair[0]["tid"] == tid2):
                            line = 'hw_bp2 = [%s, %s, %s]' % (race_pair[0]["pc"], str(sched2),hex(__start_routine2),) + '\n'
                        elif(race_pair[1]["tid"] == tid2):
                            line = 'hw_bp2 = [%s, %s, %s]' % (race_pair[1]["pc"], str(sched2),hex(__start_routine2),) + '\n'
                    data += line
            f.close()

            with open('./testcase/test_%d_%d.py' % (line_index, race_pair_index), 'w') as f:
                f.writelines(data)
            f.close()
            race_pair_index += 1
        line_index += 1

        


race_pair_f.close()










